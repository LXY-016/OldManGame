# 游戏关卡主界面需求文档 (UI Functional Specifications)
文档版本: V1.0 | 对应模块: 核心战斗/关卡循环

## 1. 界面整体布局概述 (Layout)
界面主要分为四个功能区域：
1.  **中心区域**: 场景层，游戏主要交互舞台。
2.  **下方区域**: 操作栏，显示可用的社工单位。
3.  **左上角区域**: 信息栏，显示服务人数与时间。
4.  **右上角区域**: 系统功能栏，暂停与退出。

## 2. 技术架构与分层 (Technical Architecture)
为了确保 3D 交互与 2D UI 互不冲突，采用双层架构：

### 2.1. 渲染层级 (Z-Index Layering)
*   **渲染层 (Canvas Layer)**: `Canvas` (Three.js WebGL Renderer)。负责渲染 3D 场景、老头、特效。
    *   *Events*: 监听 `pointerdown`, `pointermove`, `pointerup` 用于射线检测 (Raycasting)。
*   **UI层 (DOM Layer)**: `HTML Overlay` (Absolute Positioning)。覆盖在 Canvas 之上。
    *   包含: HUD 信息栏、底部操作栏、全屏弹窗。
    *   *Interaction*: 这里的点击事件 **必须** 阻止冒泡 (`e.stopPropagation()`)，防止误触 3D 场景。

### 2.2. 输入事件总线 (Input Handling)
由于拖拽逻辑主要涉及 UI -> 3D 世界的转换，需建立统一的输入管理器：
1.  **UI 拖拽开始**: 鼠标在 DOM 元素按下。创建临时的“幻影”跟随鼠标。
2.  **全局移动**: 监听 `window` 的移动事件。
    *   将 2D 屏幕坐标转换为 3D 射线 (`Raycaster`)。
    *   检测射线与“地板平面 (Ground Plane)”的交点，更新幻影的的 3D 位置。
3.  **释放检测**: 
    *   Raycast 检测是否击中“老人 (Elder Group)”的碰撞体 (Hitbox)。

## 3. 系统模块划分 (System Modules)
建议将逻辑拆分为独立的 ES Module，保持 Main.js 清晰：

| 模块名称 | 职责描述 | 依赖关系 |
| :--- | :--- | :--- |
| **GameLoop** | 主循环，负责计算 `deltaTime` 并调用各系统的 `.update()`。 | Main.js |
| **LevelManager** | 管理关卡状态（倒计时、服务人数、游戏结束判定）。 | UI层, Spawner |
| **SpawnerSystem** | 负责定时生成老人，管理对象池 (Object Pool)。 | Scene |
| **DragSystem** | 核心交互。处理 Raycaster，判断拖拽状态，通知社工行为。 | Camera, Scene |
| **FeedbackSystem** | 负责飘字、音效、特效的播放。 | HUD |

## 4. 详细功能需求 (Functional Specifications)

### 4.1. 中心区域 (Main Scene Area)
- **功能**: 承载游戏场景和角色行为。
- **美术需求**: 请参考 [Art Assets.md](Art%20Assets.md) - Section 2.2。
- **老人行为逻辑 (Elder Behavior)**:
    > 详细的时间机制定义与公式请参考: [Function 1 Attribute.md](Function%201%20Attribute.md) - Section 1.1
    - **生成与绑定 (Spawn & Bind)**:
        - 场景中生成老人的同时，**绑定**一个固定的需求类型 (E-01~05) 和 倒计时时长 (T-Request, 详见 `gameconfig.md` [Section 4 - tRequest])。
        - **同屏最大数量限制**: 详见 `gameconfig.md` [Section 2 - maxOnScreen]
        - 气泡始终正面朝向摄像机 (Billboard)。
    - **1. 等待中 (Waiting)**:
        - **行为**: 在小范围半径内随机漫步 (Idle Roam)，头顶显示需求气泡。
        - **流转**: 若 **响应倒计时 (T-Request)** 归零，转入 [4. 未完成离开]。若社工到达，转入 [2. 正在服务]。
    - **2. 正在服务 (Being Serviced)**:
        - **触发**: 社工被成功拖拽至判定范围内。
        - **行为**: 停止移动，原地站立并面向社工。
        - **表现**: 倒计时 (T-Request) 暂停。头顶出现新的服务进度条 (T-Action)，持续时间取决于社工属性匹配度。
        - **流转**: 进度条读满（即社工工作结束）后，转入 [3. 已完成]。
    - **3. 已完成 (Resolved)**:
        - **行为**: 播放“开心/感谢/鞠躬”动画，随后朝场景出口移动。
        - **表现**: 气泡变为“爱心/笑脸”。
        - **结果**: 销毁对象，**服务人数 +1**。
    - **4. 未完成离开 (Failed)**:
        - **行为**: 播放“摇头/叹气/生气”动画，随后朝场景出口移动。
        - **表现**: 气泡破碎或变灰。
        - **结果**: 销毁对象，不计入服务人数。

### 4.2. 下方区域 (Bottom Operation Bar)
- **功能**: 放置“社工小队”成员。
- **布局**: 屏幕底部横向排布。
- **属性标识**: 每个头像需通过图标或边框颜色暗示其**主属性**（无属性/强壮/健谈/聪明）。详见 `Art Assets.md` [Section 3.1]。
- **社工小队成员交互 (Drag & Drop)**:
    - **开始拖拽**: 
        - 玩家按住底部社工头像，生成一个 2D 图标跟随鼠标移动。
        - 原始头像在栏内变暗或显示“被拖拽中”状态。
        - **[新增] 匹配高亮逻辑**: 系统遍历场上所有老人，检测其需求是否与当前被拖拽社工的属性 **完美匹配 (Best Match)**。详见 `Function 1 Attribute.md` [Section 3.1]。
            - **匹配者**: 播放特殊的“求助高亮”动画（如气泡放大或身体发光），提示玩家优先选择。
            - **非匹配者**: 保持原状，做减法视觉引导。
    - **拖拽移动**: 
        - 拖拽物跟随鼠标 (Screen Space -> World Space Raycasting)。
        - 当拖拽物悬停在有效目标（有需求的老人）上方时：
             - **通用反馈**: 老人模型边缘显示 **金色描边**。
             - **匹配反馈**: 若属性匹配，头顶出现 “Perfect!” 提示。
        - **反馈**: 需有清晰的选中与释放判定反馈。详见 `Art Assets.md` [Section 4.3]。
    - **释放判定 (Drop)**:
        - **有效释放**: 若在老人判定范围内松手，判定为派遣成功。
            - 拖拽物消失。
            - 真正的社工模型瞬间出现在老人身旁（或播放快速跑入动画）。
            - 底部社工头像进入“工作”状态。
        - **无效释放**: 若在空地或无需求位置松手。
            - 拖拽物播放“弹回”动画或者直接消失。
            - 底部社工头像立刻恢复“待机”状态（无冷却）。

### 4.3. 社工行为逻辑 (Social Worker Behavior)
    1.  **待机 (Idle)**: 栏内亮起可用。
    2.  **工作 (Working)**: 
        - **触发**: 玩家成功释放社工到目标老人。
        - **动作**: 社工瞬移/移动到老人身旁。(服务并发限制: 1，即同一老人不可被多人协助)。
        - **交互**: 社工播放`Working`动画，老人播放`Being Helped`动画。持续时间与老人的 T-Action 进度条完全同步。
        - **结束**: 当服务进度条读满时，转入 [3. 返回]。
    3.  **返回 (Return)**: 
        - **触发**: 服务完成。
        - **动作**: 社工播放离开动画或淡出，老人进入 [Resolved] 状态并离场。
        - **结束**: 动画播放完毕后，社工回到底部栏并进入 [4. 冷却]。
    4.  **冷却 (Cooldown)**: 
        - 底部头像变灰，显示扇形倒计时遮罩。冷却时间结束后，社工自动进入 [1. 待机]。
        - **点击反馈**: 若玩家点击冷却中的头像，播放“错误/不可用”音效，并弹出轻量提示文本“休息中...”。需有明确视觉或听觉提示。详见 `Art Assets.md` [Section 4.3]。

### 4.4. 左上角区域 (HUD - Info)
- **服务人数**: 显示当前已成功服务的老人数量 (例如: "服务人数: 5")。增加时的飘字或动效 (+1)。详见 `Art Assets.md` [Section 4.3]。
- **倒计时**: MM:SS 格式。归零时锁死操作，弹出结算。

### 4.5. 右上角区域 (HUD - System)
- **退出按钮**: 暂停游戏，弹出二次确认窗。确认后返回 [启动/主界面 (Layer 0)]。
- **暂停按钮**: 游戏冻结，全屏半透明遮罩，显示“继续”按钮。

## 5. 结算界面 (Settlement Interface)
**触发条件**: 倒计时归零。
**胜利条件**: `服务人数` >= `目标人数` (详见 `gameconfig.md` [Section 2 - targetCount])。
**失败条件**: `服务人数` < `目标人数`。
**表现形式**: 覆盖全屏的半透明模态窗口 (Modal Overlay)。

### 5.1. 界面元素
*   **标题**: "今日工作结束" (Mission Complete)。
*   **工作简报 (Summary)**:
    *   **服务老人数**: 大号数字展示 ("今日共帮助了 12 位老人")。
*   **操作按钮**:
    *   **[下一关]**: 仅在达到最低通关标准时显示，否则显示重试。
    *   **[重试]**: 重新开始当前关卡。
    *   **[返回首页]**: 回到 Layer 0 启动界面。

### 5.2. 视觉反馈
*   **胜利 (Win)** / **失败 (Lose)**: 详细特效表现请参考 `Art Assets.md` [Section 5.1]。
